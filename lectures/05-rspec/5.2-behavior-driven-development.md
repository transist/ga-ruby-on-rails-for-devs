用RSpec进行行为驱动开发
======================================

在我们深入行为驱动开发*BDD*之前，让我们先更新一下我已经知道了关于测试驱动开发(*TDD*)的什么。

什么是测试驱动开发？
--------------------------------

*测试驱动开发* 是一种依赖于一开始就要写自动化测试的软件开发流程。接下来就是写具体的实现。这个过程通常被称为*红灯-绿灯-重构*:

![Red Green Refactor](http://upload.wikimedia.org/wikipedia/en/9/9c/Test-driven_development.PNG)

什么是行为驱动开发？
------------------------------------

Dan North在以下的链接里演示了测试驱动开发([source](http://dannorth.net/introducing-bdd/))

“我有一个问题。在不同的环境下，当使用和教像测试驱动开发这样的敏捷实践时，我一直有一个误解和迷惑，程序员们想要知道：”

1. **从哪开始**,
2. **哪些内容需要测试**,
3. **一次测多少内容**,
4. **怎么调用这些测试**,
5. 还有如何理解 **测试怎么就失败了呢？**."

他发明了一个技巧，叫*行为驱动开发*，来帮助回答这些在开发过程遇到的问题。

BDD核心原则
------------------

1. 测试的方法名应该像是自然语言一样的句子
    - 这样非开发者也可以理解，成为领域的[_ubiquitous language_](http://domaindrivendesign.org/node/132)，所有人都使用相同的术语。
    - 测试的名字是一整句话，应该包含行为人，而且以词语`should`开头.
    - 按照商业价值的顺序来写.
2. 通过测试强调行为
    - 解决困难的问题，“测试什么？”
    - 定义一些期望的行为，而不是一些细粒度的测试，可能依然导致错误的行为。
    - 依然需要关注应该做什么会很有帮助
3. 每一个story有一个面向用户接受的标准。由外向内进行测试。
    - 利益相关者使用相同的接口就可以接受story.
    - 允许利益相关者的快速反馈关于行为的猜测是不是对的。
    - 鼓励[YAGNI](http://en.wikipedia.org/wiki/You_ain%27t_gonna_need_it).

BDD流程
---------------

在没有一点代码的情况下，典型的通过BDD过程实现故事的流程如下：

1. 写`request spec`(aka acceptance spec)
2. 写`request spec`, 然后看着它得红灯。
3. 不管已经有的依赖，写视图的实现，（比如控制器和模型都还不存在）.
4. 写`request spec`, 然后看着它得红灯。
    1. 写`controller spec`, 然后由外向内的分解到应用中。
    2. 运行`controller spec`, 然后看着它得红灯。
    3. 编写尽可能多的控制器实现，不管不存在的模型。
    4. 运行`controller spec`, 然后看着它得红灯.
        1. 编写 `model spec`, 然后由外向内的分解到应用中。
        2. 运行 `model spec`, 然后看着它得红灯.
        3. 实现 `model`.
        4. 运行 `model spec`, 然后看着它得绿灯.
    13. 运行 `controller spec`, 然后看着它得绿灯.
14. 运行 `request spec`, 然后看着它得绿灯.
15. 搞定！

在真实环境中，你要在这些步骤之间进行重构.但这个大纲展示了你应该怎么作为行为者从应用外开始，然后逐渐深入到实现的细节，以这样的方式编写测试。

BDD实践
-------------

我们开始写细节specification，或者叫做“spec”，定义了应用特定部分的行为。
这个特定的行为被描述在一个“story”里面，一旦完成之后，产品拥有者就只能接受或者拒绝它。
`BDD`天生就是由外向内进行测试，面向外部的价值在于必须细节化和故事的完整化。

例子Story:

    用户应该可以在登陆之后创建一篇post.

注意到一个spec是如何影响行为者的。`User`操作一个行为。
从外部开始，从一个行为者的角度，我们用‘RSpec’和`capybara`编写一个请求spec(或者验收测试)来测试这个行为。

``` ruby
feature "user" do
  before do
    sign_in
  end

  scenario "should be able to post" do
    click_on "Create Post"

    page.current_address.should == new_post_path
    content = Faker::Lorem.paragraph
    fill_in "content", :with content
    click_on "Submit"

    page.current_address.should == show_post_path
    within(".content") { page.should have_content content }
  end
end
```

我们spec写完后，就可以运行测试，然后开始我们的*红灯-绿灯-重构*了，除了这个特别的spec，我们会为了未来的好日子先遇到红灯。

创建"Create Post"的链接，会让你通过一行，但是还是得到红灯。
从最基本的开始，我们没有post controller，也没有post模型。

我们现在还在外部，慢慢的步入到*里面*。

我们继续写我们的控制器spec:

``` ruby
describe "POST#post" do
  content = Faker::Lorem.paragraph
  expect {
    post :post, content: content
    assigns(:post).should_not beNil
  }.to change { Post.count }.by(1)
end
```

References
----------

- [Introducing BDD by Dan North](http://dannorth.net/introducing-bdd/)
- [Wikipedia: Behavior Driven Development](http://en.wikipedia.org/wiki/Behavior_Driven_Development)

